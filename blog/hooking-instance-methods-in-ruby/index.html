
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>rand9: Hooking instance methods in Ruby</title>
  <meta name="author" content="BJ Neilsen">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  

  <link rel="canonical" href="http://rand9.com/blog/hooking-instance-methods-in-ruby"/>
  <link href="/favicon.png" rel="shortcut icon" />
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="http://s3.amazonaws.com/ender-js/jeesh.min.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/rand9-blog" rel="alternate" title="rand9" type="application/atom+xml"/>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-6580389-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  
  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>


  
  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


  <!--Fonts from Google's Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>

</head>

<body  >
  <header><hgroup>
  <h1><a href="/">rand9</a></h1>
  
</hgroup>

</header>
  <nav role=navigation><ul role=subscription data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/rand9-blog" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="site-search">
    <input type="hidden" name="q" value="site:rand9.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul role=main-navigation>
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry">
  
  <header>
    
      <h1 class="entry-title">Hooking Instance Methods in Ruby</h1>
    
    
      <p class="meta">




<time datetime="2010-09-18 16:00:18 -0600" pubdate  updated >Sep 18<span>th</span>, 2010</time>


</p>
    
  </header>


<div class="entry-content"><p>Everyone and their dog is familiar with ActiveRecord-style callbacks, you know, the kind where you specify you want a particular method or proc to be run before or after a given event on your model. It helps you enforce the principles of code ownership while making it trivial to do the hardwiring, ensuring that code owned by the model is also managed by the model.</p>

<p>I love this kind of programming and recently found that I needed some similar functionality in a particular class, one that wasn&#8217;t tied to Active<em>[Insert your railtie here]</em>. My case was different in that I knew that <em>any</em> class inheriting from a particular base, which we&#8217;ll call <code>HookBase</code>, needed a hardwired hook for every method defined, functionality that needed to run for virtually every instance method call. The following example illustrates my need:</p>

<figure role=code><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="k">class</span> <span class="nc">HookBase</span>
</div><div class='line'>  <span class="k">def</span> <span class="nf">hardwired_hook</span>
</div><div class='line'>    <span class="c1"># functionality every method needs</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'><span class="k">end</span>
</div><div class='line'>
</div><div class='line'><span class="k">class</span> <span class="nc">MyClass</span> <span class="o">&lt;</span> <span class="no">HookBase</span>
</div><div class='line'>  <span class="k">def</span> <span class="nf">find_widget</span>
</div><div class='line'>    <span class="c1"># needs setup/teardown help from HookBase</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'><span class="k">end</span>
</div></code></pre></td></tr></table></div></figure>

<p>So, operating from the idea that every instance method extending classes implement should have default wrap-around behavior, I got to work. First off, you need to know that ruby has built-in lifecycle hooks on your classes, objects, and modules. Things like <code>included</code> and <code>extended</code> and <code>method_added</code> help you hook in to your code to ensure that the appropriate things are happening on your classes, objects, and modules. So in my case, I needed to know when a method was added to <code>HookBase</code> (or one of its children) so that I could appropriately tap into that code.</p>

<p><code>method_added</code> is where the meat of the solution lies. When a method is added, ruby fires the method_added call on the object (if any exists), passing it the name of the new method. Keep in mind that this happens <em>after</em> the method has already been created, which is crucial to this solution. We&#8217;ll next create a new name from the old name, prepended with some identifier (in this case we chose &#8220;hide_&#8221;).</p>

<p>We&#8217;ll need to check the private_instance_methods array for already defined method names to ensure we&#8217;re not duplicating our effort (or clobbering someone elses), as well as checking our own array constant for methods we don&#8217;t want to hook. Remember that method_added will be called on every method that is found for HookBase as well as children. I found that there were HookBase methods I had implemented that were supporting this behavior and didn&#8217;t need to be hardwired, so I added this to my list of methods to ignore.</p>

<p>If we&#8217;ve made it this far, go ahead and alias the old method to the new one, then privatize the new one. Now we can safely redefine the old method without destroying the code it contained. We also now know that no one (except self) can invoke the private method directly, they&#8217;ll have to implicitly go through the HookBase first.</p>

<p>Redefining the old method is as simple as using <code>define_method</code> and calling our hardwired_hook method within, passing our <code>new_method</code> (which is privatized), and the old method (for convenience), and any associated arguments and blocks.</p>

<p>The final implementation looks something like this:</p>

<figure role=code><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
<span class='line'>13</span>
<span class='line'>14</span>
<span class='line'>15</span>
<span class='line'>16</span>
<span class='line'>17</span>
<span class='line'>18</span>
<span class='line'>19</span>
<span class='line'>20</span>
<span class='line'>21</span>
<span class='line'>22</span>
<span class='line'>23</span>
<span class='line'>24</span>
<span class='line'>25</span>
<span class='line'>26</span>
<span class='line'>27</span>
<span class='line'>28</span>
<span class='line'>29</span>
<span class='line'>30</span>
<span class='line'>31</span>
<span class='line'>32</span>
<span class='line'>33</span>
<span class='line'>34</span>
<span class='line'>35</span>
<span class='line'>36</span>
<span class='line'>37</span>
<span class='line'>38</span>
<span class='line'>39</span>
<span class='line'>40</span>
<span class='line'>41</span>
<span class='line'>42</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="k">class</span> <span class="nc">HookBase</span>
</div><div class='line'>  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
</div><div class='line'>    <span class="no">NON_HOOK_METHODS</span> <span class="o">=</span> <span class="sx">%w( hardwired_hook some_other_method )</span>
</div><div class='line'>
</div><div class='line'>    <span class="k">def</span> <span class="nf">method_added</span> <span class="n">old</span>
</div><div class='line'>      <span class="n">new_method</span> <span class="o">=</span> <span class="ss">:&quot;hide_</span><span class="si">#{</span><span class="n">old</span><span class="si">}</span><span class="ss">&quot;</span>
</div><div class='line'>      <span class="k">return</span> <span class="k">if</span> <span class="p">(</span><span class="nb">private_instance_methods</span> <span class="o">&amp;</span> <span class="o">[</span><span class="n">old</span><span class="p">,</span> <span class="n">new_method</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">old</span> <span class="o">=~</span> <span class="sr">/^hide_/</span> <span class="ow">or</span> <span class="no">NON_HOOK_METHODS</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">old</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span>
</div><div class='line'>
</div><div class='line'>      <span class="n">alias_method</span> <span class="n">new_method</span><span class="p">,</span> <span class="n">old</span>
</div><div class='line'>      <span class="kp">private</span> <span class="n">new_method</span>
</div><div class='line'>
</div><div class='line'>      <span class="n">define_method</span> <span class="n">old</span> <span class="k">do</span> <span class="o">|*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="o">|</span>
</div><div class='line'>        <span class="n">hardwired_hook</span> <span class="n">new_method</span><span class="o">.</span><span class="n">to_sym</span><span class="p">,</span> <span class="n">old</span><span class="o">.</span><span class="n">to_sym</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span>
</div><div class='line'>      <span class="k">end</span>
</div><div class='line'>    <span class="k">end</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'>
</div><div class='line'><span class="kp">private</span>
</div><div class='line'>
</div><div class='line'>  <span class="c1"># Hardwired handler for all method calls</span>
</div><div class='line'>  <span class="k">def</span> <span class="nf">hardwired_hook</span> <span class="n">new_method</span><span class="p">,</span> <span class="n">old_method</span><span class="p">,</span> <span class="n">args</span><span class="o">*</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span>
</div><div class='line'>    <span class="c1"># perform any before actions</span>
</div><div class='line'>    <span class="nb">puts</span> <span class="s1">&#39;doing stuff before method call...&#39;</span>
</div><div class='line'>
</div><div class='line'>    <span class="c1"># Invoke the privatized method</span>
</div><div class='line'>    <span class="nb">__send__</span> <span class="n">new_method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span>
</div><div class='line'>
</div><div class='line'>    <span class="c1"># perform any after actions</span>
</div><div class='line'>    <span class="nb">puts</span> <span class="s1">&#39;doing stuff after the method call...&#39;</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'><span class="k">end</span>
</div><div class='line'>
</div><div class='line'><span class="k">class</span> <span class="nc">MyClass</span> <span class="o">&lt;</span> <span class="no">HookBase</span>
</div><div class='line'>  <span class="k">def</span> <span class="nf">find_widget</span>
</div><div class='line'>    <span class="nb">puts</span> <span class="s1">&#39;finding widget...&#39;</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'><span class="k">end</span>
</div><div class='line'>
</div><div class='line'><span class="no">MyClass</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">find_widget</span>
</div><div class='line'><span class="c1"># doing any before actions</span>
</div><div class='line'><span class="c1"># finding widget...</span>
</div><div class='line'><span class="c1"># doing any after actions</span>
</div></code></pre></td></tr></table></div></figure>

<p>The great thing about this approach is you may not even care about hardwiring anything, but just want to provide hooking functionality. If that&#8217;s the case, simply define a class method in HookBase to register a hook (such as <code>before</code> or <code>after</code>), optionally accepting an <code>:only</code> or <code>:except</code> list of methods. Internally store the blocks passed and invoke them in the <code>hardwired_hook</code> method either before or after the method call.</p>

<p>Let me know if you have any comments or different approaches. Happy hacking!</p>

<p><strong>UPDATE</strong>: Forgot that method_added needs to be defined in <code>class &lt;&lt; self</code> to work properly. Also updated to use the <code>Array#&amp;</code> intersection method I described in <a href="/blog/intersecting_arrays_in_ruby">Intersecting arrays in ruby</a> instead of using <code>Array#include?</code>.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">BJ Neilsen</span></span>

      




<time datetime="2010-09-18 16:00:18 -0600" pubdate  updated >Sep 18<span>th</span>, 2010</time>



      

<span class="categories">
  
    <a class='category' href='/blog/tags/hooks/'>hooks</a>, <a class='category' href='/blog/tags/meta-programming/'>meta-programming</a>, <a class='category' href='/blog/tags/ruby/'>ruby</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://rand9.com/blog/hooking-instance-methods-in-ruby" data-via="localshred" data-counturl="http://rand9.com/blog/hooking-instance-methods-in-ruby" >Tweet</a>
  
  
  <g:plusone size="medium"></g:plusone>
  
</div>

    
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread"><div id="disqus_thread"></div>
<script type="text/javascript">
  var disqus_shortname = 'rand9';
  var disqus_identifier = 'http://rand9.com/blog/hooking-instance-methods-in-ruby';
  var disqus_url = 'http://rand9.com/blog/hooking-instance-methods-in-ruby';
  //var disqus_developer = 1;
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside role=sidebar>
  
    <section>
  <h1>About rand9</h1>
  
  <p><img src="http://www.gravatar.com/avatar/c8ef74aab2e973ba0f7da5557e0ba9a9?s=128&amp;d=identicon&amp;r=PG" width="" height="" alt="BJ Neilsen" title="BJ Neilsen"></p>

  <p>rand9 is the outpouring of though from <a href="http://twitter.com/#!/localshred" title="@localshred">@localshred</a>; Father of two, developer, lead software architect <a href="http://twitter.com/#!/MoneyDesktop" title="@MoneyDesktop">@MoneyDesktop</a>, soccer coach &amp; fanatic, <a href="http://twitter.com/#!/RealSaltLake" title="@RealSaltLake">@RealSaltLake</a> devotee, gardener, chicken-raiser, infrequent triathlete, climber, and all around outdoors enthusiast.</p>

</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/picking-the-right-number-as-quickly-as-possible">Binary search in ruby, or, &#8220;Picking the right number, as quickly as possible&#8221;</a>
      </li>
    
      <li class="post">
        <a href="/blog/git-pre-receive-hook-for-rejecting-a-bad-gemfile">Git pre-receive hook for rejecting a bad Gemfile</a>
      </li>
    
      <li class="post">
        <a href="/blog/thor-script-for-managing-a-unicorn-driven-app">Thor script for managing a Unicorn-driven app</a>
      </li>
    
      <li class="post">
        <a href="/blog/mapping-object-values-with-rubys-ampersand-symbol-technique">Mapping object values with Ruby&#8217;s ampersand-symbol technique</a>
      </li>
    
      <li class="post">
        <a href="/blog/areas-of-focus">Areas of Focus</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("localshred", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/localshred" class="twitter-follow-button" data-width="208px" data-show-count="false">Follow @localshred</a>
  
</section>




  
</aside>


    </div>
  </div>
  <footer><p>
  Copyright &copy; 2011 - BJ Neilsen -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
</body>
</html>
